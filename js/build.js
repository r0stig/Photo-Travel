function Common(){}Common.implodeTags=function(a,b){"undefined"===typeof b&&(b=",");var c="",d=a.get("tags");d&&(d.each(function(a){c+=a.get("name")+b}),c=c.substr(0,c.length-b.length));return c};var pictureModel=Backbone.Model.extend({url:function(){return this.isNew()?BASE_API_URL+"picture/":BASE_API_URL+"picture/"+this.id},parse:function(a){null!=a&&(a.tags=new tagCollection(a.tags));return a}});var userModel=Backbone.Model.extend({url:function(){return this.isNew()?BASE_API_URL+"user/":BASE_API_URL+"user/"+this.id}});var tagModel=Backbone.Model.extend({});var generalTagModel=Backbone.Model.extend({});var userPicturesCollection=Backbone.Collection.extend({model:pictureModel,url:function(){return BASE_API_URL+"pictures/user/"+this.get("picturesByUser")}});var userCollection=Backbone.Collection.extend({model:userModel,url:function(){return BASE_API_URL+"users/"}});var pictureCollection=Backbone.Collection.extend({model:pictureModel,url:function(){return BASE_API_URL+"pictures/user/"+this.get("picturesByUser")},fetchByUser:function(a,b){this.url=BASE_API_URL+"pictures/user/"+a;return this.fetch(b)},fetchByTags:function(a,b){this.url=BASE_API_URL+"pictures/tags/"+a;return this.fetch(b)}});var tagCollection=Backbone.Collection.extend({model:tagModel});var generalTagCollection=Backbone.Collection.extend({model:generalTagModel,url:function(){return BASE_API_URL+"tags"}});var pictureListView=Backbone.View.extend({template:_.template($("#pictureslisttemplate").html()),initialize:function(){this.collection=this.options.collection},render:function(){var a=this;$(this.el).html(this.template());this.collection.each(function(b){a.renderItem(b)});return this},renderItem:function(a){a=new pictureSingleView({model:a});$(this.el).find("#singlePictureContainer").append(a.render().el)}});var pictureMgmtListView=Backbone.View.extend({template:_.template($("#picturesmanagement_listtemplate").html()),initialize:function(){this.collection=this.options.collection;this.collection.on("reset",this.onReset,this)},render:function(){var a=this;$(this.el).html(this.template());this.collection.each(function(b){a.renderItem(b)});return this},renderItem:function(a){a=new pictureMgmtSingleView({model:a});$(this.el).find("#picMgmtListContainer").append(a.render().el)},onReset:function(){console.log("onReset");
this.render()}});var pictureMgmtSingleView=Backbone.View.extend({template:_.template($("#picturesmanagement_singletemplate").html()),initialize:function(){this.model=this.options.model;this.model.on("change",this.render,this)},render:function(){var a=Common.implodeTags(this.model,", ");$(this.el).html(this.template({model:this.model.toJSON(),tags:a}));return this},events:{"click button[name=mgmtEditBtn]":"doEdit","click button[name=mgmtDeleteBtn]":"doDelete"},doEdit:function(){window.router.navigate("management/edit/"+
this.model.id,!0)},doDelete:function(){var a=this;this.model.destroy({error:function(){console.log(arguments)},success:function(){a.remove()}})}});var pictureMgmtEditView=Backbone.View.extend({template:_.template($("#picturesmanagement_edittemplate").html()),initialize:function(){var a=this;this.model=new pictureModel;this.model.id=this.options.picture_id;this.model.fetch({success:function(b,c){console.log(b,c);a.render()},error:function(){console.log("error",arguments)}})},render:function(){var a=Common.implodeTags(this.model);$(this.el).html(this.template({model:this.model.toJSON(),tags:a}));$(this.el).find("input[name=tags]").tagit();return this},
events:{"click input[name=managementEditButton]":"doEdit","click input[name=managementCancelButton]":"doCancel"},doEdit:function(){this.model.save({description:$(this.el).find("textarea[name=description]").val(),tags:$(this.el).find("input[name=tags]").val()},{success:function(a,b){console.log("success edit",a,b);window.router.navigate("management",!0)},error:function(){console.log("error",arguments)}})},doCancel:function(){window.router.navigate("management",!0)},close:function(){this.undelegateEvents()}});var pictureMgmtView=Backbone.View.extend({template:_.template($("#picturespicture_managementtemplate").html()),initialize:function(){this.collection=new pictureCollection;this.collection.fetchByUser(USER_ID,{success:function(){console.log("success")},error:function(){console.log(arguments)}});this.pictureMgmtListView=new pictureMgmtListView({collection:this.collection});$(this.el).find("#mgmtEditContainer").hide();$(this.el).find("#mgmtMyPicContainer").show();vent.on("mgmtEdit",this.doEdit,this);
vent.on("mgmtEditCancel",this.doEditCancel,this);vent.on("mgmtEditSuccess",this.doEditSuccess,this)},render:function(){$(this.el).html(this.template());$(this.el).find("input[name=tags]").tagit({});$(this.el).find("#picMgmtMyPictures").html(this.pictureMgmtListView.render().el);$("#pictureUpload").submit(function(){console.log($(":text",this).serializeArray());$.ajax(this.action,{data:{description:$("textarea[name=description]").val(),tags:$("input[name=tags]").val()},files:$(":file",this),iframe:!0,
processData:!0}).complete(function(a){console.log(a)});return!1});return this},events:{},doUpload:function(){console.log(this);var a=$("#pictureUpload");$.ajax(a.action,{files:$(":file",a),iframe:!0}).complete(function(a){console.log(a)});return!1},doEdit:function(a){a=new pictureMgmtEditView({model:a});$(this.el).find("#mgmtEditContainer").html(a.render().el);$(this.el).find("#mgmtEditContainer").show();$(this.el).find("#mgmtMyPicContainer").hide()},doEditCancel:function(){$(this.el).find("#mgmtEditContainer").hide();
$(this.el).find("#mgmtMyPicContainer").show()},doEditSuccess:function(){$(this.el).find("#mgmtEditContainer").hide();$(this.el).find("#mgmtMyPicContainer").show()},close:function(){this.unbind()}});var pictureMapView=Backbone.View.extend({template:_.template($("#picturesmaptemplate").html()),map:{},infoWindow:{},initialize:function(){var a=this,b=this.options.user_id||0,c=this.options.tag||null;this.collection=new pictureCollection;0!=b?this.collection.fetchByUser(b,{success:function(){console.log("success (fetchByUser)");a.centerFirstPicture();a.renderPictures();a.renderMarkers()},error:function(){console.log(arguments)}}):null!=c&&this.collection.fetchByTags(c,{success:function(){console.log("success (fetchByTag)");
a.centerFirstPicture();a.renderPictures();a.renderMarkers()},error:function(){console.log(arguments)}});this.pictureListView=new pictureListView({collection:this.collection});vent.on("scrollTo",this.onScrollTo,this);this.infoWindow=new google.maps.InfoWindow({disableAutoPan:!0})},render:function(){$(this.el).html(this.template());this.renderMap()},renderPictures:function(){$(this.el).find("#pictureListContainer").html(this.pictureListView.render().el)},renderMap:function(){var a={center:new google.maps.LatLng(36.853046944444,
28.271021111111),zoom:8,mapTypeId:google.maps.MapTypeId.ROADMAP};this.map=new google.maps.Map(document.getElementById("map_canvas"),a)},centerFirstPicture:function(){var a=this.collection.at(0).get("latitude"),b=this.collection.at(0).get("longitude");this.map.panTo(new google.maps.LatLng(a,b))},renderMarkers:function(){var a=this,b=BASE_URL+"icons/16x16/image.png";this.collection.each(function(c){var d=new google.maps.LatLng(c.get("latitude"),c.get("longitude")),c=new google.maps.Marker({position:d,
map:a.map,icon:b,model:c});google.maps.event.addListener(c,"mouseover",function(){var b=this.model;a.infoWindow.setContent('<img src="'+b.get("uri_medium")+'" /> <br />By '+b.get("name")+" "+b.get("surname")+" at "+b.get("photo_shot"));a.infoWindow.open(a.map,this)});google.maps.event.addListener(c,"mouseout",function(){a.infoWindow.close()})})},onScrollTo:function(a){this.map.panTo(new google.maps.LatLng(a.lat,a.lng));console.log("map::onScrollTo")},close:function(){$(this.el).undelegate()}});var pictureSingleView=Backbone.View.extend({template:_.template($("#picturessingletemplate").html()),initialize:function(){this.model=this.options.model},render:function(){var a=Common.implodeTags(this.model,", ");$(this.el).html(this.template({model:this.model.toJSON(),tags:a}));return this},events:{"click .actionScroll":"doScroll"},doScroll:function(){vent.trigger("scrollTo",{lat:this.model.get("latitude"),lng:this.model.get("longitude")})}});var findView=Backbone.View.extend({template:_.template($("#picturesfindtemplate").html()),initialize:function(){var a=new userCollection,b=new generalTagCollection;a.fetch({success:function(){},error:function(){console.log(arguments)}});b.fetch({success:function(){},error:function(){console.log(arguments)}});this.userListView=new userListView({collection:a});this.tagListView=new tagListView({collection:b})},render:function(){$(this.el).html(this.template());$(this.el).find("#findUsersContainer").html(this.userListView.render().el);
$(this.el).find("#findTagsContainer").html(this.tagListView.render().el)},close:function(){$(this.el).undelegate()}});var userListView=Backbone.View.extend({template:_.template($("#picturesuser_listtemplate").html()),initialize:function(){this.collection=this.options.collection;this.collection.on("reset",this.onReset,this)},render:function(){var a=this;$(this.el).html(this.template());this.collection.each(function(b){a.renderItem(b)});return this},renderItem:function(a){a=new userSingleView({model:a});$(this.el).find("#findUserList tbody").append(a.render().el)},onReset:function(){console.log("onReset");this.render()}});var userSingleView=Backbone.View.extend({template:_.template($("#picturesuser_singletemplate").html()),tagName:"tr",initialize:function(){this.model=this.options.model},render:function(){$(this.el).html(this.template({model:this.model.toJSON()}));return this}});var tagListView=Backbone.View.extend({template:_.template($("#picturestag_listtemplate").html()),initialize:function(){this.collection=this.options.collection;this.collection.on("reset",this.onReset,this)},render:function(){var a=this;$(this.el).html(this.template());this.collection.each(function(b){a.renderItem(b)});return this},renderItem:function(a){a=new tagSingleView({model:a});$(this.el).find("#findTagList tbody").append(a.render().el)},onReset:function(){console.log("onReset");this.render()}});var tagSingleView=Backbone.View.extend({template:_.template($("#picturestag_singletemplate").html()),tagName:"tr",initialize:function(){this.model=this.options.model},render:function(){$(this.el).html(this.template({model:this.model.toJSON()}));return this}});var AppRouter=Backbone.Router.extend({initialize:function(){this.currentView=void 0},routes:{management:"showManagement","management/edit/:id":"managementEditPicture","map/user/:id":"mapUserPictures","map/tag/:tag":"mapTagPictures","*actions":"defaultAction"},showManagement:function(){var a=new pictureMgmtView({el:$("#container")});this.beforeSwap(a);a.render()},managementEditPicture:function(a){a=new pictureMgmtEditView({el:$("#container"),picture_id:a});this.beforeSwap(a);a.render()},mapUserPictures:function(a){a=
new pictureMapView({el:$("#container"),user_id:a});this.beforeSwap(a);a.render()},mapTagPictures:function(a){a=new pictureMapView({el:$("#container"),tag:a});this.beforeSwap(a);a.render()},defaultAction:function(a){console.log("No route:",a);a=new findView({el:$("#container")});this.beforeSwap(a);a.render()},beforeSwap:function(a){void 0!=this.currentView&&this.currentView.close();this.currentView=a},afterSwap:function(){}});$(function(){vent=_.extend({},Backbone.Events);window.router=new AppRouter;Backbone.history.start()});
